<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home - Soroteca</title>
    <link rel="icon" href="../v1/icon" type="image/x-icon" />
    <link rel="stylesheet" href="/pagina-principal/style.css" />
    <script
      src="https://kit.fontawesome.com/cf6fa412bd.js"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <style>
      /* Fonts */
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

      /* General Reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
      }

      /* Root Variables */
      :root {
        --color-primary: #bdc3c7;
        --color-secondary: #aecfe1;
        --color-light: #f4f7fa;
        --color-dark: #2c3e50;
        --color-white: #ffffff;
        --color-border: #ccd1d9;
        --color-hover: #467ec7;
        --color-error: #da4141;
        --color-disabled: #da4141;

        --font-small: 0.875rem;
        --font-medium: 1rem;
        --font-large: 1.25rem;
        --font-extra-large: 1.5rem;

        --padding-small: 8px;
        --padding-medium: 16px;
        --padding-large: 24px;

        --border-radius: 8px;
        --box-shadow: 0 2px 5px rgba(8, 57, 97, 0.1);
      }

      /* Body */
      body {
        background-color: var(--color-light);
        color: var(--color-dark);
        line-height: 1.6;
      }

      /* Header */
      header {
        background-color: var(--color-white);
        padding: var(--padding-large) 8%;
        box-shadow: var(--box-shadow);
      }

      #navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-logo {
        width: 180px;
        height: auto;
      }

      #nav_list {
        display: flex;
        list-style: none;
        gap: var(--padding-large);
      }

      .nav-item a {
        text-decoration: none;
        color: var(--color-primary);
        font-size: var(--font-medium);
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .nav-item a:hover {
        color: var(--color-hover);
      }

      .nav-item i {
        margin-right: 8px;
        color: var(--color-primary);
      }

      .container {
        background-color: var(--color-white);
        margin: var(--padding-large) auto;
        margin-top: 50px;
        max-width: 1200px;
        padding: var(--padding-large);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
      }

      .input-group label {
        display: block;
        margin-bottom: 15px;
        font-weight: 600;
        font-size: 20px;
        color: #2c3e50;
      }

      .input-group select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e4e8;
        border-radius: 8px;
        background-color: #f8f9fa;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .input-group select:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
      }

      .trash-button,
      .refresh-button {
        background-color: #ffffff;
        border: 2px solid #e0e4e8;
        color: #2c3e50;
        padding: 10px 15px;
        margin-top: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .trash-button:hover,
      .refresh-button:hover {
        background-color: #f1f3f5;
        border-color: #3498db;
      }

      .trash-button i {
        color: #e74c3c;
      }

      .refresh-button i {
        color: #3498db;
      }

      .result {
        display: grid;
        width: 100%;
        grid-template-columns: repeat(10, 1fr);
        gap: 10px;
        margin-top: 20px;
      }

      .position {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
        background-color: #da4141;
        border-radius: 6px;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .position:hover {
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .position.occupied {
        background-color: #bdc3c7;
        color: #34495e;
        cursor: not-allowed;
      }

      #infos-banks {
        margin-top: 20px;
        font-size: 16px;
        color: #2c3e50;
      }

      /* Responsive Adjustments */
      @media (max-width: 1200px) {
        .container {
          margin: var(--padding-large) 5%;
        }
      }

      @media (max-width: 768px) {
        #navbar {
          flex-direction: column;
          gap: 20px;
        }

        #nav_list {
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
        }

        .nav-item {
          margin-bottom: 10px;
        }

        .input-group {
          margin-bottom: var(--padding-medium);
        }

        .positions {
          grid-template-columns: repeat(5, 1fr);
        }

        .result {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: var(--padding-medium);
        }

        .positions {
          grid-template-columns: repeat(3, 1fr);
        }

        .result {
          grid-template-columns: repeat(2, 1fr);
        }

        #nav_list {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>

  <body>
    <header>
      <nav id="navbar">
        <img class="nav-logo" src="../v1/soroteca-logo" alt="nav_logo" />

        <ul id="nav_list">
          <li class="nav-item">
            <i
              style="color: rgb(55, 88, 126); font-size: 20px"
              ;
              class="fa-solid fa-chalkboard-user"
            ></i>
            <a href="../v1/index">Home</a>
          </li>
          <li class="nav-item">
            <i
              style="color: rgb(55, 88, 126); font-size: 20px"
              ;
              class="fa-solid fa-vial"
            ></i>
            <a href="../v1/index">Soroteca</a>
          </li>
          <li class="nav-item">
            <i
              style="color: rgb(55, 88, 126); font-size: 20px"
              ;
              class="fa-solid fa-eye-dropper"
            ></i>
            <a href="../v1/transaction">Alocação</a>
          </li>
          <li class="nav-item">
            <i
              style="color: rgb(55, 88, 126); font-size: 20px"
              ;
              class="fa-solid fa-magnifying-glass"
            ></i>
            <a href="../v1/search">Pesquisa</a>
          </li>
          <li class="nav-item">
            <i
              style="color: rgb(55, 88, 126); font-size: 20px"
              ;
              class="fa-solid fa-power-off"
            ></i>
            <a href="../v1/login">Login in/Logout </a>
          </li>
        </ul>
      </nav>
    </header>

    <main id="content">
      <section>
        <div id="confirmationModal" style="display: none">
          <div class="modal-content">
            <h2>Confirmação</h2>
            <p>Tem certeza de que deseja excluir todas as amostras?</p>
            <button class="confirm-button" onclick="confirmDelete()">
              Sim
            </button>
            <button class="cancel-button" onclick="closeModal()">Não</button>
          </div>
        </div>
      </section>

      <section>
        <div class="container">
          <div class="input-group">
            <label for="bankSelect">Selecione a Bandeja:</label>
            <select
              id="bankSelect"
              onchange="fetchAvailablePositions()"
            ></select>
            <button class="refresh-button" onclick="refreshOptions()">
              <i class="fas fa-sync-alt"></i>
            </button>
            <button
              class="trash-button"
              onclick="deleteAllSamples(getSelectedBankCode())"
            >
              <i class="fas fa-trash"></i>
            </button>
            <p id="infos-banks"></p>
          </div>

          <div class="result" id="result">
            <!-- As posições serão exibidas aqui -->
          </div>
        </div>
        <footer
          style="
            background-color: var(--color-white);
            padding: var(--padding-large) 8%;
            box-shadow: var(--box-shadow);
            text-align: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 100;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              max-width: 1200px;
              margin: 0 auto;
            "
          >
            <div style="flex: 1; text-align: left">
              <h4
                style="
                  color: var(--color-dark);
                  margin-bottom: var(--padding-small);
                  font-size: var(--font-large);
                "
              >
                Soroteca
              </h4>
              <p
                style="
                  color: var(--color-primary);
                  font-size: var(--font-small);
                "
              >
                Gestão eficiente de amostras laboratoriais
              </p>
            </div>
            <div style="flex: 1; text-align: right">
              <p
                style="
                  color: var(--color-primary);
                  font-size: var(--font-small);
                "
              >
                © 2024 Soroteca
              </p>
              <div
                style="
                  display: flex;
                  justify-content: flex-end;
                  gap: var(--padding-small);
                  margin-top: var(--padding-small);
                "
              >
                <i
                  class="fab fa-facebook"
                  style="color: var(--color-primary)"
                ></i>
                <i
                  class="fab fa-twitter"
                  style="color: var(--color-primary)"
                ></i>
                <i
                  class="fab fa-linkedin"
                  style="color: var(--color-primary)"
                ></i>
              </div>
            </div>
          </div>
        </footer>
      </section>
    </main>
    <script>
      function getSelectedBankCode() {
        const bankSelect = document.getElementById('bankSelect');
        return bankSelect.value;
      }

      function getCurrentDayIndex() {
        const today = new Date();
        let dayOfWeek = today.getDay();
        return dayOfWeek !== 0 ? dayOfWeek * 2 : dayOfWeek;
      }

      async function loadSerumBanks() {
        try {
          const response = await fetch('../v1/serum-banks');
          if (!response.ok)
            throw new Error('Erro ao carregar os bancos de soro.');

          const { response: serumBanks } = await response.json();
          const bankSelect = document.getElementById('bankSelect');

          const selectOption = document.createElement('option');
          selectOption.value = ''; // Empty value for "selecione"
          selectOption.textContent = 'SELECIONE';
          bankSelect.appendChild(selectOption);

          serumBanks.forEach((bank) => {
            const option = document.createElement('option');
            option.value = bank.serumBankCode;
            option.textContent = bank.serumBankCode;
            bankSelect.appendChild(option);
          });

          if (serumBanks.length > 0) fetchAvailablePositions();
        } catch (error) {
          document.getElementById('result').innerHTML =
            `<p>Erro: ${error.message}</p>`;
        }
      }

      let selectedBankCodeForDelete;

      function openModal() {
        document.getElementById('confirmationModal').style.display = 'flex';
      }

      function closeModal() {
        document.getElementById('confirmationModal').style.display = 'none';
      }

      function deleteAllSamples(serumBankCode) {
        selectedBankCodeForDelete = serumBankCode;
        openModal();
      }

      async function confirmDelete() {
        closeModal();

        const url = `../v1/serum-banks/samples/${selectedBankCodeForDelete}/allSamples`;

        try {
          const refreshButton = document.getElementById('refresh-button');
          refreshButton.addEventListener('click', refreshOptions);

          const response = await fetch(url, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
          });

          if (response.status === 204) {
            refreshOptions();
          } else {
            console.error(
              `Failed to delete all samples. Status: ${response.status}`,
            );
          }
        } catch (error) {
          console.error('Error while deleting all samples:', error);
        }
      }
      async function fetchAvailablePositions() {
        const bankCode = getSelectedBankCode();
        const resultDiv = document.getElementById('result');
        const infosBanks = document.getElementById('infos-banks');

        if (!bankCode) {
          infosBanks.innerHTML =
            '<p>Por favor, selecione um banco de soro.</p>';
          return;
        }

        try {
          const [positionsResponse, samplesResponse] = await Promise.all([
            fetch(`../v1/serum-banks/${bankCode}/available-positions`),
            fetch(`../v1/serum-banks/${bankCode}/samples`),
          ]);

          if (!positionsResponse.ok)
            throw new Error('Erro ao obter as posições disponíveis.');

          const occupiedPositions = await positionsResponse.json();
          const samples = await samplesResponse.json();
          console.log('Samples:', samples);
          // const samplesCodes = samples.map(sample => sample.sampleCode);

          renderPositions(occupiedPositions, samples);
        } catch (error) {
          resultDiv.innerHTML = `<p>Erro: ${error.message}</p>`;
        }
      }

      function renderPositions(occupiedPositions, samples) {
        console.log(samples);
        const resultDiv = document.getElementById('result');
        const infosBanks = document.getElementById('infos-banks');
        resultDiv.innerHTML = '';
        infosBanks.innerHTML = `<p>Posições ocupadas: ${samples.length}</p>`;

        for (let i = 0; i < 100; i++) {
          const positionDiv = document.createElement('div');
          positionDiv.className = 'position';
          positionDiv.textContent = i;

          positionDiv.title = samples[i] || 'VAZIA';
          const sampleInfo = samples.find((sample) => sample.position === i);
          positionDiv.title = sampleInfo
            ? sampleInfo.sample.sampleCode
            : 'VAZIA';

          if (occupiedPositions.includes(i)) {
            positionDiv.classList.add('occupied');
          }

          positionDiv.addEventListener('click', () => {
            resultDiv
              .querySelectorAll('.position')
              .forEach((p) => p.classList.remove('selected'));
            positionDiv.classList.add('selected');
          });

          resultDiv.appendChild(positionDiv);
        }
      }

      function refreshOptions() {
        loadSerumBanks();
      }

      window.onload = loadSerumBanks;
    </script>
  </body>
</html>
